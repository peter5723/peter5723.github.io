
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Peter">
      
      
      
        <link rel="prev" href="../../signal/ch6_ss/">
      
      
        <link rel="next" href="../riscv/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>PA_note - Peter's home</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7C['Inconsolata']:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"['Inconsolata']"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/riscv.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Peter&#39;s home" class="md-header__button md-logo" aria-label="Peter's home" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Peter's home
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PA_note
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Peter&#39;s home" class="md-nav__button md-logo" aria-label="Peter's home" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Peter's home
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    build a website
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            build a website
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../website/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../website/github-pages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jekyll
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../website/pic-bed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    图床
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vscode
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/shell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    shell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vim
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/make/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GNU Make
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/ssh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    化学
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            化学
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chem/thermo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    化学热力学中的一些问题
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    信号
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            信号
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../signal/onesidez/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    z变换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../signal/DFT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DFT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../signal/stft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    短时傅里叶变换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../signal/ch6_ss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LTI系统频域特性（ss第6章）
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    计算机系统
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            计算机系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    PA 实验记录
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    PA 实验记录
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pa0-tools" class="md-nav__link">
    <span class="md-ellipsis">
      PA0 (tools)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA0 (tools)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    <span class="md-ellipsis">
      C语言
    </span>
  </a>
  
    <nav class="md-nav" aria-label="C语言">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#macro" class="md-nav__link">
    <span class="md-ellipsis">
      macro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      作用域和链接
    </span>
  </a>
  
    <nav class="md-nav" aria-label="作用域和链接">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      作用域
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      链接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      存储时期
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      字符串处理函数：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inline-volatile" class="md-nav__link">
    <span class="md-ellipsis">
      inline 和 volatile 关键字
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      内联汇编
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clash" class="md-nav__link">
    <span class="md-ellipsis">
      clash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gcc" class="md-nav__link">
    <span class="md-ellipsis">
      gcc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gdb" class="md-nav__link">
    <span class="md-ellipsis">
      gdb
    </span>
  </a>
  
    <nav class="md-nav" aria-label="gdb">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting" class="md-nav__link">
    <span class="md-ellipsis">
      Starting:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-and-stopping" class="md-nav__link">
    <span class="md-ellipsis">
      Running and Stopping:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breakpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Breakpoint:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examining-code" class="md-nav__link">
    <span class="md-ellipsis">
      Examining code:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#display" class="md-nav__link">
    <span class="md-ellipsis">
      Display
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layout" class="md-nav__link">
    <span class="md-ellipsis">
      Layout:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#else" class="md-nav__link">
    <span class="md-ellipsis">
      Else:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-frame" class="md-nav__link">
    <span class="md-ellipsis">
      TODO: frame 找段错误
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#makefile" class="md-nav__link">
    <span class="md-ellipsis">
      Makefile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vim" class="md-nav__link">
    <span class="md-ellipsis">
      vim
    </span>
  </a>
  
    <nav class="md-nav" aria-label="vim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      杂项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vim_1" class="md-nav__link">
    <span class="md-ellipsis">
      vim多文件编辑
    </span>
  </a>
  
    <nav class="md-nav" aria-label="vim多文件编辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vim-itself" class="md-nav__link">
    <span class="md-ellipsis">
      vim itself
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nerdtree" class="md-nav__link">
    <span class="md-ellipsis">
      nerdtree
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugin-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Plugin introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plugin introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vundle" class="md-nav__link">
    <span class="md-ellipsis">
      vundle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ctags" class="md-nav__link">
    <span class="md-ellipsis">
      ctags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cscope" class="md-nav__link">
    <span class="md-ellipsis">
      cscope
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#youcompleteme" class="md-nav__link">
    <span class="md-ellipsis">
      YouCompleteMe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      linux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tmux" class="md-nav__link">
    <span class="md-ellipsis">
      tmux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tmux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      会话
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#window" class="md-nav__link">
    <span class="md-ellipsis">
      window
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      窗格
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      寻求帮助
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa1" class="md-nav__link">
    <span class="md-ellipsis">
      PA1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      框架介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      怎么开机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      题目回答 注意事项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa2" class="md-nav__link">
    <span class="md-ellipsis">
      PA2
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-nemu" class="md-nav__link">
    <span class="md-ellipsis">
      1. NEMU 中，一条指令是怎么完整执行的
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. NEMU 中，一条指令是怎么完整执行的">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      取指
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      译码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pc" class="md-nav__link">
    <span class="md-ellipsis">
      更新 PC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nemu" class="md-nav__link">
    <span class="md-ellipsis">
      NEMU 是什么？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-am" class="md-nav__link">
    <span class="md-ellipsis">
      2. AM 是什么？运行时环境是什么？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. AM 是什么？运行时环境是什么？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      具体实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-am-nemu" class="md-nav__link">
    <span class="md-ellipsis">
      3. AM 程序怎么构建，怎么在 NEMU 中运行？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-io" class="md-nav__link">
    <span class="md-ellipsis">
      4. IO 设备
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. IO 设备">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      声卡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 杂项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-makefile" class="md-nav__link">
    <span class="md-ellipsis">
      6. makefile 的各种问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa3" class="md-nav__link">
    <span class="md-ellipsis">
      PA3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pa31" class="md-nav__link">
    <span class="md-ellipsis">
      PA3.1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA3.1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      处理异常的过程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#yield-test" class="md-nav__link">
    <span class="md-ellipsis">
      yield test 发生了什么
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa-32" class="md-nav__link">
    <span class="md-ellipsis">
      PA 3.2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa-33" class="md-nav__link">
    <span class="md-ellipsis">
      PA 3.3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa4" class="md-nav__link">
    <span class="md-ellipsis">
      PA4
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA4">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pa41" class="md-nav__link">
    <span class="md-ellipsis">
      PA4.1 多道程序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa42" class="md-nav__link">
    <span class="md-ellipsis">
      PA4.2 分页
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa-43" class="md-nav__link">
    <span class="md-ellipsis">
      PA 4.3 栈切换
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../riscv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RISC-V
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../number/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数字与算术
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    链接和程序结构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    栈和函数调用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基本存储
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚拟内存
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO 和文件系统
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callback/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    回调函数
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    操作系统
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            操作系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../os/osnote/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os 实验记录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../os/thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../os/src/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xv6 源代码
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    算法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            算法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2" >
        
          
          <label class="md-nav__link" for="__nav_9_2" id="__nav_9_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    搜索
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2">
            <span class="md-nav__icon md-icon"></span>
            搜索
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/search/DFS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DFS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/dp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    动态规划
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            C++
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Cpp/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS106L 笔记
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    书
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            书
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wen/LaPeste/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    鼠疫
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wen/sisyphe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    西西弗神话
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wen/outsider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    局外人
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wen/kab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    卡拉马佐夫兄弟
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wen/beggar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    赌徒
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    diary
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            diary
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12_1" >
        
          
          <label class="md-nav__link" for="__nav_12_1" id="__nav_12_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    one diary
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12_1">
            <span class="md-nav__icon md-icon"></span>
            one diary
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../diary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    one one diary
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pa0-tools" class="md-nav__link">
    <span class="md-ellipsis">
      PA0 (tools)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA0 (tools)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    <span class="md-ellipsis">
      C语言
    </span>
  </a>
  
    <nav class="md-nav" aria-label="C语言">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#macro" class="md-nav__link">
    <span class="md-ellipsis">
      macro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      作用域和链接
    </span>
  </a>
  
    <nav class="md-nav" aria-label="作用域和链接">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      作用域
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      链接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      存储时期
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      字符串处理函数：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inline-volatile" class="md-nav__link">
    <span class="md-ellipsis">
      inline 和 volatile 关键字
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      内联汇编
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clash" class="md-nav__link">
    <span class="md-ellipsis">
      clash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gcc" class="md-nav__link">
    <span class="md-ellipsis">
      gcc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gdb" class="md-nav__link">
    <span class="md-ellipsis">
      gdb
    </span>
  </a>
  
    <nav class="md-nav" aria-label="gdb">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting" class="md-nav__link">
    <span class="md-ellipsis">
      Starting:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-and-stopping" class="md-nav__link">
    <span class="md-ellipsis">
      Running and Stopping:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breakpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Breakpoint:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examining-code" class="md-nav__link">
    <span class="md-ellipsis">
      Examining code:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#display" class="md-nav__link">
    <span class="md-ellipsis">
      Display
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layout" class="md-nav__link">
    <span class="md-ellipsis">
      Layout:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#else" class="md-nav__link">
    <span class="md-ellipsis">
      Else:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-frame" class="md-nav__link">
    <span class="md-ellipsis">
      TODO: frame 找段错误
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#makefile" class="md-nav__link">
    <span class="md-ellipsis">
      Makefile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vim" class="md-nav__link">
    <span class="md-ellipsis">
      vim
    </span>
  </a>
  
    <nav class="md-nav" aria-label="vim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      杂项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vim_1" class="md-nav__link">
    <span class="md-ellipsis">
      vim多文件编辑
    </span>
  </a>
  
    <nav class="md-nav" aria-label="vim多文件编辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vim-itself" class="md-nav__link">
    <span class="md-ellipsis">
      vim itself
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nerdtree" class="md-nav__link">
    <span class="md-ellipsis">
      nerdtree
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugin-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Plugin introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plugin introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vundle" class="md-nav__link">
    <span class="md-ellipsis">
      vundle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ctags" class="md-nav__link">
    <span class="md-ellipsis">
      ctags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cscope" class="md-nav__link">
    <span class="md-ellipsis">
      cscope
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#youcompleteme" class="md-nav__link">
    <span class="md-ellipsis">
      YouCompleteMe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      linux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tmux" class="md-nav__link">
    <span class="md-ellipsis">
      tmux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tmux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      会话
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#window" class="md-nav__link">
    <span class="md-ellipsis">
      window
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      窗格
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      寻求帮助
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa1" class="md-nav__link">
    <span class="md-ellipsis">
      PA1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      框架介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      怎么开机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      题目回答 注意事项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa2" class="md-nav__link">
    <span class="md-ellipsis">
      PA2
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-nemu" class="md-nav__link">
    <span class="md-ellipsis">
      1. NEMU 中，一条指令是怎么完整执行的
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. NEMU 中，一条指令是怎么完整执行的">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      取指
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      译码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pc" class="md-nav__link">
    <span class="md-ellipsis">
      更新 PC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nemu" class="md-nav__link">
    <span class="md-ellipsis">
      NEMU 是什么？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-am" class="md-nav__link">
    <span class="md-ellipsis">
      2. AM 是什么？运行时环境是什么？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. AM 是什么？运行时环境是什么？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      具体实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-am-nemu" class="md-nav__link">
    <span class="md-ellipsis">
      3. AM 程序怎么构建，怎么在 NEMU 中运行？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-io" class="md-nav__link">
    <span class="md-ellipsis">
      4. IO 设备
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. IO 设备">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      声卡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 杂项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-makefile" class="md-nav__link">
    <span class="md-ellipsis">
      6. makefile 的各种问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa3" class="md-nav__link">
    <span class="md-ellipsis">
      PA3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pa31" class="md-nav__link">
    <span class="md-ellipsis">
      PA3.1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA3.1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      处理异常的过程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#yield-test" class="md-nav__link">
    <span class="md-ellipsis">
      yield test 发生了什么
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa-32" class="md-nav__link">
    <span class="md-ellipsis">
      PA 3.2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa-33" class="md-nav__link">
    <span class="md-ellipsis">
      PA 3.3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pa4" class="md-nav__link">
    <span class="md-ellipsis">
      PA4
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA4">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pa41" class="md-nav__link">
    <span class="md-ellipsis">
      PA4.1 多道程序
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa42" class="md-nav__link">
    <span class="md-ellipsis">
      PA4.2 分页
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa-43" class="md-nav__link">
    <span class="md-ellipsis">
      PA 4.3 栈切换
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="_1">实验手册<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本文是Peter的NJU PA的实验手册。只记录一些<strong>东西</strong>，不提供源代码。</p>
<p><a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2023/index.html">课程网址</a>在这里。</p>
<h2 id="pa0-tools">PA0 (tools)<a class="headerlink" href="#pa0-tools" title="Permanent link">&para;</a></h2>
<p>If you have problems in conflicting debs, just use the original source rather than tsinghua or ustc. It wastes a lot of time.</p>
<p>包冲突的解决：直接用ubuntu提供的源即可，不用阿里云或者清华云了。可以保证下载速度的，也不会有冲突。</p>
<p>终于可以输入中文了。好骚的sogou输入法.</p>
<p>先安装一些必要的工具：
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>apt-get install build-essential    # build-essential packages, include binary utilities, gcc, make, and so on
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>apt-get install man                # on-line reference manual
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>apt-get install gcc-doc            # on-line reference manual for gcc
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>apt-get install gdb                # GNU debugger
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>apt-get install git                # revision control system
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>apt-get install libreadline-dev    # a library used later
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>apt-get install libsdl2-dev        # a library used later
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>apt-get install llvm llvm-dev      # llvm project, which contains libraries used later
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>apt-get install vim                # vim
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>apt-get install vim-gtk            # vim-more
</code></pre></div></p>
<h3 id="c">C语言<a class="headerlink" href="#c" title="Permanent link">&para;</a></h3>
<p>沧海遗珠的细节</p>
<h4 id="macro">macro<a class="headerlink" href="#macro" title="Permanent link">&para;</a></h4>
<p>一是讨论一下<code>#include</code>的路径.</p>
<p>若是用<code>&lt;&gt;</code>那么就是在标准目录中寻找文件</p>
<p>若是用<code>""</code>, 就是在当前目录(c文件所在的位置)寻找文件. 写法和linux中目录的写法一致, 比如在上级文件夹下的另一个文件夹, 可以写成<code>#include "../another/hello.h"</code></p>
<p>一般要把函数声明放在头文件中, 这样可以需要这个函数的c文件引用这个头文件就可以使用该函数了.</p>
<p>头文件的内容一般包含: 明显常量, 宏, 函数声明, 结构模板定义和类型定义. </p>
<p>在去年上数据结构课的时候, 碰到过这样的问题, 有多个文件引用<code>list.h</code>,  导致<code>list.h</code>中的结构类型<code>node</code>被重定义的问题. </p>
<p><strong>c语言中,声明可以重复很多次, 但是定义只能有一次</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">a</span><span class="p">();</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">a</span><span class="p">();</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">a</span><span class="p">();</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1">//这样不会报错</span>
</code></pre></div>
<p>怎么解决这个问题呢, 就是用条件编译指令了:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cp">#ifndef LIST</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="cp">#define LIST</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="o">*</span><span class="n">PtrToNode</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">typedef</span><span class="w"> </span><span class="n">PtrToNode</span><span class="w"> </span><span class="n">List</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="k">typedef</span><span class="w"> </span><span class="n">PtrToNode</span><span class="w"> </span><span class="n">Position</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="n">List</span><span class="w"> </span><span class="nf">MakeEmpty</span><span class="p">(</span><span class="n">List</span><span class="w"> </span><span class="n">L</span><span class="p">);</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="kt">int</span><span class="w"> </span><span class="nf">IsListEmpty</span><span class="p">(</span><span class="n">List</span><span class="w"> </span><span class="n">L</span><span class="p">);</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="kt">int</span><span class="w"> </span><span class="nf">IsLast</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="n">P</span><span class="p">,</span><span class="n">List</span><span class="w"> </span><span class="n">L</span><span class="p">);</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Insert</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">X</span><span class="p">[],</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">L</span><span class="p">);</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="n">Position</span><span class="w"> </span><span class="nf">Find</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">X</span><span class="p">[],</span><span class="n">List</span><span class="w"> </span><span class="n">L</span><span class="p">);</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="p">{</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">Element</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="n">Position</span><span class="w"> </span><span class="n">Next</span><span class="p">;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="p">};</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="cp">#endif</span>
</code></pre></div>
<p>如上所示<code>ifndef</code>指令保证结构类型只被定义一次. <code>ifndef</code>指令常常用于防止多次包含同一文件, 保证这个文件只被包含一次.</p>
<h4 id="_2">作用域和链接<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<h5 id="_3">作用域<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h5>
<p>一个C变量的作用域可以是代码块作用域/函数原型作用域/文件作用域.</p>
<p>对于一个全局变量来说, 它具有文件作用域, 整个文件都可以使用它</p>
<h5 id="_4">链接<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h5>
<p>c变量可以有外部链接/内部链接/空链接</p>
<p>对于一个局部变量来说, 它是只有空链接, 由代码块或者函数原型私有, 只有文件作用域的变量才讨论内部还是外部链接.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">giant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">}</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1">//main.c</span>
</code></pre></div>
<p><code>giant</code>就具有外部链接, 其他文件都可以使用<code>giant</code>, 只要加上<code>extern</code>关键字:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">giant</span><span class="p">;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">...</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1">//foo.c</span>
</code></pre></div>
<p>但是<code>dog</code>有<code>static</code>标识, 那么他就是<code>main.c</code>所私有的, 其他文件无法访问. 这里<code>static</code>声明是说该全局变量具有内部链接.</p>
<details class="tips" open="open">
<summary>Tips</summary>
<p>注意：
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">giant</span><span class="p">;</span>
</code></pre></div>
是声明</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">giant</span><span class="p">;</span>
</code></pre></div>
是定义。
C语言声明可以有很多次，而定义只能有一次。故若要使用同名的独立的全局变量，必须加 static 关键字。而如果使用的是外部变量，除非是第一次定义，否则必须加 extern 声明。如果在两个文件中同时定义了 <code>int giant</code>，则会报错。</p>
</details>
<h5 id="_5">存储时期<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h5>
<p><code>static</code>还有一个地方会碰到, 就是声明一个变量是静态存储时期. 一般的变量都是自动存储时期, 作用域结束就释放. 而静态存储时期的变量, 在整个程序执行期间一直存在. 很显然, 不管加不加<code>static</code>, 全局变量都一定是静态变量. 自动变量不初始化, 静态变量缺省地初始化为0.</p>
<h4 id="_6">字符串处理函数：<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p><strong>strtok</strong></p>
<p>用于字符串切割</p>
<p><code>char *strtok(char *str, const char *delim)</code></p>
<ul>
<li><strong>str</strong> -- 要被分解成一组小字符串的字符串。</li>
<li><strong>delim</strong> -- 包含分隔符的 C 字符串。</li>
</ul>
<p>该函数返回被分解的第一个子字符串，如果没有可检索的字符串，则返回一个空指针。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">str</span><span class="p">[</span><span class="mi">90</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;I    love you   So     much&quot;</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">);</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="p">}</span>
</code></pre></div>
<p>会输出如下结果</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>I
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>love
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>love
</code></pre></div>
<p>注意:</p>
<ol>
<li>
<p><code>strtok</code>是会改变原字符串的, 在<code>str</code>的第一个被分隔的位置将<code>delim</code>中对应的字符替换成<code>\0</code></p>
</li>
<li>
<p>如果要继续分割当前字符串, <code>a = strtok(NULL, " ");</code>即可, 
    和<code>b = strtok(str+strlen(token)+1, " ");</code>的效果是一样的, <code>strlen(token)</code>是前面被分割的总长度.</p>
</li>
<li>
<p>没有了, 就这样.</p>
</li>
</ol>
<p><strong>strncpy</strong></p>
<p><code>char *strncpy(char *dest, char *src, size_t n)</code></p>
<p>将<code>src</code>赋值到<code>dest</code>, 返回<code>dest</code>的首地址, 最多复制n个字符</p>
<p><strong>sprintf</strong></p>
<p><code>int sprintf(char* dest, char *format_string, ...)</code></p>
<p>将格式化字符串输出到<code>dest</code>中</p>
<p><strong>sscanf</strong></p>
<p><code>int sscanf(const char *src, const char *format, ...)</code></p>
<p>和<code>scanf</code>基本一样, 只是<code>sscanf</code>是从<code>src</code>中读取数据. </p>
<h4 id="inline-volatile">inline 和 volatile 关键字<a class="headerlink" href="#inline-volatile" title="Permanent link">&para;</a></h4>
<p>内联函数的参考链接: <a href="https://blog.csdn.net/zqixiao_09/article/details/50877383">https://blog.csdn.net/zqixiao_09/article/details/50877383</a></p>
<p>如果一个函数定义用 inline 关键字修饰的话, 表示它是内联函数, 它的编译结果将不使用栈空间, 而是就如同普通的代码一样运行. 所以内联函数是没有函数地址的.</p>
<p>标准规定具有内联函数的定义与调用该函数的代码必须在同一个文件中, 所以定义内联函数通常都同时使用关键字 static 和 inline.</p>
<p>举个例子: 
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kr">inline</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">isEven</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;}</span>
</code></pre></div></p>
<p>只有在运行简单的函数时, 内联函数才有优化效果. 如果函数复杂, 每一处调用函数的部分都要复制一份这样的代码, 这样很占用内存(原本跳转到函数地址, 只需要一份代码即可). 而且, 复杂的代码, 用内联节省不了多少时间. 另外, 内联函数是不能执行递归的, 因为普通函数的递归是栈实现的.</p>
<p>volatile 关键字则表示某个变量是可变的, 要求编译器每次使用这个变量时都要从内存中重新读取. 注意, 有时做了优化, 想速度快一点, 编译器编译出的代码会直接从寄存器读取, 但是如果有多个线程的情况下, 另外一个线程可能会改变变量的值, 导致内存中的值和寄存器中的值不符. 对于这种情况, 我们就要用 volatile 来声明变量.</p>
<p>如下面的例子</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</code></pre></div>
如果没有 volatile, 编译器在执行 <code>b = i</code> 时可能就直接优化成 <code>b = a</code>, 但是可能另外一个线程会改变 i, 这样就会导致变量 b 被赋错误的值.</p>
<h4 id="_7">内联汇编<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>参考链接：<a href="https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html#toc2">https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html#toc2</a></p>
<p><a href="https://blog.csdn.net/lyndon_li/article/details/118471845">https://blog.csdn.net/lyndon_li/article/details/118471845</a></p>
<p>语法很简单：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">asm</span><span class="p">(</span><span class="s">&quot;assembly code&quot;</span><span class="p">);</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;assembly code&quot;</span><span class="p">);</span>
</code></pre></div>
两种都可以。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">asm</span><span class="p">(</span><span class="s">&quot;movl %ecx %eax&quot;</span><span class="p">);</span><span class="w"> </span><span class="cm">/* moves the contents of ecx to eax */</span>
</code></pre></div>
<p>如果有多条指令，每行都加双引号，每行的结尾都加换行符和 tab 键。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;movl %eax, %ebx</span><span class="se">\n\t</span><span class="s">&quot;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">          </span><span class="s">&quot;movl $56, %esi</span><span class="se">\n\t</span><span class="s">&quot;</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">          </span><span class="s">&quot;movl %ecx, $label(%edx,%ebx,$4)</span><span class="se">\n\t</span><span class="s">&quot;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">          </span><span class="s">&quot;movb %ah, (%ebx)&quot;</span><span class="p">);</span>
</code></pre></div>
<p>前面都是很直接的嵌入汇编指令，还有扩展内联汇编，可以指定操作数，和 c 语言的变量进行交互。扩展内联汇编的语法如下：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">assembler</span><span class="w"> </span><span class="n">template</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">operands</span><span class="w">                </span><span class="cm">/* optional */</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">operands</span><span class="w">                 </span><span class="cm">/* optional */</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">clobbered</span><span class="w"> </span><span class="n">registers</span><span class="w">    </span><span class="cm">/* optional */</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="p">);</span>
</code></pre></div>
这种格式由四部分组成，第一部分是汇编指令，和上面的例子一样，第二部分和第三部分是约束条件，第二部分指示汇编指令的运算结果要输出到哪些 C 操作数中，C 操作数应该是左值表达式，第三部分指示汇编指令需要从哪些 C 操作数获得输入，第四部分是在汇编指令中被修改过的寄存器列表，指示编译器哪些寄存器的值在执行这条 asm 语句时会改变。后三个部分都是可选的，如果有就填写，没有就空着只写个 <code>:</code> 号。</p>
<p>举个例子吧：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">{</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="p">;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;movl %3, %%eax </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="s">&quot;movl %%eax, %1 </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">        </span><span class="o">:</span><span class="s">&quot;=b&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="s">&quot;=c&quot;</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="o">:</span><span class="s">&quot;d&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="s">&quot;S&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">        </span><span class="o">:</span><span class="s">&quot;%eax&quot;</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="p">}</span>
</code></pre></div>
<p>解释一下，一个 <code>%</code> 表示操作数，两个 <code>%</code> 表示寄存器。数字表示操作数的顺序，从 0 开始。第二、第三部分中的操作数前的引号内的内容是修饰符，常见的修饰符，<code>=</code> 表示只写操作数只写（输出操作数），<code>a/b/c/d/S/D</code> 表示将操作数放入 <code>eax/ebx/ecx/edx/esi/edi</code>，<code>r</code> 表示将输入变量放入上述任一通用寄存器。</p>
<p>于是上面的汇编代码，<code>%3</code> 表示汇编代码中第 4 个操作数，即 <code>b</code>,  <code>%1</code> 表示第 2 个寄存器，即 <code>d</code>，很容易知道，最后 <code>d</code> 的值是 20，故上述代码输出 20。</p>
<p>为了防止汇编代码被编译器优化，可以加上 <code>volatile</code> 关键字
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">...);</span>
</code></pre></div></p>
<h3 id="clash">clash<a class="headerlink" href="#clash" title="Permanent link">&para;</a></h3>
<p>首先照readme将url改成订阅地址</p>
<p>后面 按提示即可</p>
<p><code>sudo bash start.sh</code></p>
<p><code>source /etc/profile.d/clash.sh</code></p>
<p><code>proxy_on</code> 打开代理</p>
<p><code>proxy_off</code>关闭代理</p>
<p><code>sudo bash shutdown.sh</code>关闭程序</p>
<p>这样弄好以后，再打开系统的代理:</p>
<p>ubuntu桌面版，右上角点击设置，网络，网络代理，手动，然后把http://127.0.0.1和7890</p>
<p>Then you can google and github freely.</p>
<h3 id="gcc">gcc<a class="headerlink" href="#gcc" title="Permanent link">&para;</a></h3>
<p><code>-g</code>  增加调试指令</p>
<p>gcc 可以增加警告，警告视作错误。</p>
<p>gcc 可以只输出宏定义展开，不编译。</p>
<h3 id="gdb">gdb<a class="headerlink" href="#gdb" title="Permanent link">&para;</a></h3>
<h4 id="starting">Starting:<a class="headerlink" href="#starting" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>  gdb
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>  gdb &lt;file&gt; ----   open gdb with the file
</code></pre></div>
<h4 id="running-and-stopping">Running and Stopping:<a class="headerlink" href="#running-and-stopping" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>  quit   ----  exit gdb
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>  **please run the program before debug...** 
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>  run    ----  run the program(&lt;file&gt;)   
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>  run 1 2 3  ---- run program with command-line arguments 1 2 3
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>  kill  ---- stop the program
</code></pre></div>
<h4 id="breakpoint">Breakpoint:<a class="headerlink" href="#breakpoint" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>  info break ---- list all breaks 
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>  (b)
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>  break &lt;func&gt; ---- Set breakpoint at the entry to &lt;func&gt;
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>  break  *0x80483c3 ----Set breakpoint at address 0x80483c3
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>  break  9  ---- Set breakpoint at line 9
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>  break main.c:9 if q==0 ---- conditional breakpoint
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>  delete     ----     delete all breakpoints
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>  delete 1   ----     delete the breakpoint 1
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>  disable 1   ----    disable the breakpoint 1
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>  enable 1    ----    enable the breakpoint 1
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>  clear &lt;func&gt; ----   Clear any points at the entry to &lt;func&gt;
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>  (w)
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>  watch *地址    # 当地址所指内容发送变化时断点
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>  watch var    #当var值变化时，断点
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>  watch (condition)    #当条件符合时，断点
</code></pre></div>
<h4 id="execution">Execution:<a class="headerlink" href="#execution" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>  stepi ---- Execute 1 instruction (assemble instruction)
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>  stepi 4 ---Execute 4 instruction (assemble instruction)
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>  nexti ---- Execute 1 instruction, but it doesn&#39;t enter the  function and just execute it
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>  step ---- Execute one C statement
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>  next ---- Execute one C Statement but doesn&#39;t enter the function.
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>  c(continue) -- -- execute to the next breakpoint
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>  until 3 ---- continue exec until the breakpoint 3
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>  finish ----   Resume execution until the current function return. 
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>  call &lt;func&gt; ---- call the func and print the return Value
</code></pre></div>
<h4 id="examining-code">Examining code:<a class="headerlink" href="#examining-code" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>  (p)
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>  print /d $rax ----  Print contents of %rax in decimal
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>  print /x $rax ----  Print contents of %rax in hex
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>  print /t $rax ----  Print contents of %rax in binary
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>  print /d (int)$rax ---- Print contents of %rax in decimal but it has signs.
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>  Examine:
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>  x/[num][size][format] address
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>  num = number of objects todisplay
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>  size = size of each project (b=byte h=half-word, w=word, g=quad-word) 
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>  (1 word = 4 Byte)
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>  FORMAT = how to display each object (d=decimal, x=hex, o=octal, etc.)
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>  for example:
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>   x/w  $rax
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>   x/2wd 0xbffff890
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>   x/200bc $rdi
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>   x/s   $rsp (a string)
</code></pre></div>
<h4 id="display">Display<a class="headerlink" href="#display" title="Permanent link">&para;</a></h4>
<p>Compared with <code>examine</code>, If we use display, the value will be printed each time the code is stopped, which is very convenient.
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>  info display ---- get all the info of variables
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>  display {var1 var2 var3} ---- print var1 var2 var3 each time.
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>  display /i $pc ---- print where is pc at as asm.
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>  delete display (%num) ---- delete all or %numth variable
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>  disable/enable display (%num) ---- disable/enable %numth variable.
</code></pre></div></p>
<h4 id="layout">Layout:<a class="headerlink" href="#layout" title="Permanent link">&para;</a></h4>
<p><strong>use <code>layout</code> to display what you want, like source code .</strong> 
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>  layout regs
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>  layout split ---- asm and src
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>  layout asm
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>  layout src
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>  layout prev
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>  layout next
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>  focus name
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>  (name = cmd|src|asm|regs|next|prev)
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>  refresh
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>  update
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>  &lt;C-l&gt; refresh
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>  &lt;C-x&gt; 1/2 ---- 1/2 window
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>  &lt;c-x&gt; a  ---- abort window
</code></pre></div></p>
<h4 id="else">Else:<a class="headerlink" href="#else" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>  where  ----   Print the current address and stack backtrace
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>  list ---- see which line the code has examined and its contexts.
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    backtrace(bt) ---  Print the backtrace of the entire stack. 
</code></pre></div>
<h4 id="todo-frame">TODO: frame 找段错误<a class="headerlink" href="#todo-frame" title="Permanent link">&para;</a></h4>
<h3 id="makefile">Makefile<a class="headerlink" href="#makefile" title="Permanent link">&para;</a></h3>
<h3 id="vim">vim<a class="headerlink" href="#vim" title="Permanent link">&para;</a></h3>
<h4 id="_8">杂项<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>用vim之前先在<code>.vimrc</code>中配置。</p>
<p>与系统剪贴板复制粘贴使用<code>+y</code> and <code>+p</code>.</p>
<p><code>&lt;C-G&gt;</code> 显示文件信息</p>
<p><code>q:</code> 显示历史命令 用<code>&lt;C-G&gt;</code>关闭(实际上和宏有关，有机会展开)</p>
<p><code>%</code> 是找匹配的括号，在复制函数时很有用。</p>
<p>`` 偶然发现可以用这个方便的跳转</p>
<p><code>.</code> 重复上一条指令</p>
<h4 id="vim_1">vim多文件编辑<a class="headerlink" href="#vim_1" title="Permanent link">&para;</a></h4>
<p>怎么使用vim像vscode那样同时编辑多个文件呢？
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>$vim txt1 txt2 ---- 打开txt1和txt2
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>$vim -o txt1 txt2 ---- 打开txt1和txt2在同一个水平窗口里面
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>$vim -O txt1 txt2 ---- 打开txt1和txt2在同一个垂直窗口里面
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>&lt;C-w&gt; + w/hjkl ----- 切换窗口
</code></pre></div></p>
<h5 id="vim-itself">vim itself<a class="headerlink" href="#vim-itself" title="Permanent link">&para;</a></h5>
<p>在编辑器内
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>:sp 将窗口水平分割成两个
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>:vsp 将窗口垂直分割成两个
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>:n下一个文件 :N上一个文件
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>:buffers ---- 显示当前所有正在编辑的文件
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>:buffer %n ---- 切换到第n个文件
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>:e txt3 ---- 打开txt3
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>ZZ ---- 保存当前文件更改
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>:wq ---- 保存所有文件更改
</code></pre></div></p>
<h5 id="nerdtree">nerdtree<a class="headerlink" href="#nerdtree" title="Permanent link">&para;</a></h5>
<p>实际上，使用<code>nerdtree</code>插件更为好用</p>
<p>我用<code>F2</code>打开这个插件</p>
<p>打开以后，仍然可以用<code>&lt;C-w&gt; + w/hjkl</code> 在代码窗口和tree窗口切换</p>
<p><code>o</code>在当前窗口打开文件、文件夹</p>
<p><code>t</code>在新tab里打开文件、文件夹（文件夹就是新树了）</p>
<p><code>gt/gT</code>在tab之间切换</p>
<p><code>s</code>垂直打开标签页</p>
<p><code>r</code> 刷新树</p>
<p>（当然，也可以用鼠标点。）</p>
<p>除此之外，nerdtree 当然也支持对文件的增删查找等。用它就不用到外部命令行新建文件了。基本上用 <code>m</code> 打开菜单栏就可以实现。
具体看这个链接：<a href="https://blog.csdn.net/weixin_37926734/article/details/124919260">https://blog.csdn.net/weixin_37926734/article/details/124919260</a></p>
<h4 id="plugin-introduction">Plugin introduction<a class="headerlink" href="#plugin-introduction" title="Permanent link">&para;</a></h4>
<h5 id="vundle">vundle<a class="headerlink" href="#vundle" title="Permanent link">&para;</a></h5>
<p><code>vim +PluginInstall +qall</code></p>
<p>安装新的包。</p>
<h5 id="ctags">ctags<a class="headerlink" href="#ctags" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>ctags -R 在当前文件夹下面创建tags
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>&lt;C-]&gt; 跳转到定义处
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>&lt;C-t&gt; 返回
</code></pre></div>
<h5 id="cscope">cscope<a class="headerlink" href="#cscope" title="Permanent link">&para;</a></h5>
<p>我已经配置过：
<code>&lt;C-\&gt; + %ch</code>  等价于:<code>cscope find %ch &lt;name at cursor&gt;</code></p>
<p>于是
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>:cscope find s   # symbol: find all references to the token under cursor
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>:cscope find g   # global: find global definition(s) of the token under cursor
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>:cscope find c   # calls:  find all calls to the function name under cursor
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>:cscope find t   # text:   find all instances of the text under cursor
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>:cscope find e   # egrep:  egrep search for the word under cursor
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>:cscope find f   # file:   open the filename under cursor
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>:cscope find i   # includes: find files that include the filename under cursor
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>:cscope find d   # called: find functions that function under cursor calls
</code></pre></div></p>
<p>在使用 cscope 时，可以输入 <code>:cw</code> 来打开 quickfix 窗口，来显示所有结果出现的位置。
在 quickfix 窗口切换不同的匹配项，可以输入 <code>:cs cn</code> 切换到下一个匹配项，<code>:cs cp</code> 切换到上一个匹配项。
当然，上下左右hjkl也可以。</p>
<h5 id="youcompleteme">YouCompleteMe<a class="headerlink" href="#youcompleteme" title="Permanent link">&para;</a></h5>
<p>very powerful.</p>
<p>在.vimrc中配置, 配置去网上抄. c语言要装clang先.</p>
<p>个人配置的备忘: </p>
<p>选择补选项: 一是用上下方向键, 二是用<code>&lt;C-N&gt;</code>和<code>&lt;C-P&gt;</code>, 实际上原本默认是tab键选择的, 但是被我禁用了现在.</p>
<p>按了enter选中后是已经补全了, 但还是会剩下一个框. 不用管它继续编程即可.</p>
<h3 id="linux">linux<a class="headerlink" href="#linux" title="Permanent link">&para;</a></h3>
<h3 id="tools">tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h3>
<h4 id="tmux">tmux<a class="headerlink" href="#tmux" title="Permanent link">&para;</a></h4>
<h5 id="_9">会话<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h5>
<p>tmux可以用来打开多个terminal。</p>
<p>命令行下输入<code>tmux</code>, 打开新会话。</p>
<p><code>tmux new -s &lt;session-name&gt;</code>可以给新会话取名字。</p>
<p><code>tmux info</code> 会话信息</p>
<p>基本操作流程：</p>
<ol>
<li>新建会话<code>tmux new -s my_session</code>。</li>
<li>在 Tmux 窗口运行所需的程序。</li>
<li>按下快捷键Ctrl+b d将会话分离。</li>
<li>下次使用时，重新连接到会话<code>tmux attach-session -t my_session</code>。
当然用<code>tmux a</code>可以快速连接上一个会话。</li>
</ol>
<p>对tmux来说，最重要的快捷键就是<code>&lt;C-b&gt;</code>, 先输入这个，然后输入指令tmux才会响应。
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>Ctrl+b d ---- 分离当前会话。
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>Ctrl+b s ---- 列出所有会话。
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>Ctrl+b $ ---- 重命名当前会话
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>Ctrl+b : ---- 进入命令行模式
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>:kill-server 删除所有会话
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>:kill-session 删除当前会话
</code></pre></div></p>
<h5 id="window">window<a class="headerlink" href="#window" title="Permanent link">&para;</a></h5>
<p>一个会话内，tmux可以包含多个窗口（感觉窗口和会话差不多，不赘述）
似乎还是窗口更方便切换啊。
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>&lt;C-b&gt; c ---- new window
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>&lt;C-b&gt; n ---- next window
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>&lt;C-b&gt; p ---- last window
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>&lt;C-b&gt; %num ---- to %numth window
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>&lt;C-b&gt; , ---- rename window
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>&lt;C-b&gt; [ ---- 进入复制模式（可以上下滚动屏幕），ESC 退出
</code></pre></div></p>
<h5 id="_10">窗格<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h5>
<p>也可以包含多个窗格
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>Ctrl+b %：划分左右两个窗格。
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>Ctrl+b &quot;：划分上下两个窗格。
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>Ctrl+b &lt;arrow key&gt;：光标切换到其他窗格。括号表示方向键。
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>Ctrl+b x：删除该窗格
</code></pre></div></p>
<h3 id="_11">寻求帮助<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>Search The Fucking Web(STFW)</p>
<p>Read The Fucking Manual(RTFM)</p>
<p>Read The Fucking Source Code(RTFSC)</p>
<h2 id="pa1">PA1<a class="headerlink" href="#pa1" title="Permanent link">&para;</a></h2>
<p>how to run <code>nemu</code>? enter <code>nemu</code> dictionary and <code>make</code> to complile, <code>make run</code> to run, <code>make gdb</code> to use gdb to debug.  </p>
<h3 id="_12">框架介绍<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>TRM - Turing Machine.</p>
<p>存储器是个在<code>nemu/src/memory/paddr.c</code>中定义的大数组.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>static uint8_t pmem[CONFIG_MSIZE] PG_ALIGN = {};
</code></pre></div>
<p>上面的代码定义了<code>pmem</code>,对应128M的存储空间</p>
<p>PC和通用寄存器都在<code>nemu/src/isa/$ISA/include/isa-def.h</code>中的结构体中定义.
寄存器有关的在全局变量<code>cpu</code>中,
包括<code>cpu.pc</code>程序计数器
和<code>cpu.gpr[n]</code>n表示第n个寄存器。</p>
<p><code>nemu/src/cpu/cpu-exec.c</code>中有和指令执行相关的内容
<code>cpu_exec(n)</code>表示执行接下来的n条指令。</p>
<h3 id="_13">怎么开机<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>初始化nemu的代码在<code>monitor.c</code>中定义
前面都是些必要的准备工作，介绍一下<code>init_isa()</code>函数，在<code>nemu/src/isa/$ISA/init.c</code>中定义
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">init_isa</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">  </span><span class="cm">/* Load built-in image. */</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">guest_to_host</span><span class="p">(</span><span class="n">RESET_VECTOR</span><span class="p">),</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">img</span><span class="p">));</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">  </span><span class="cm">/* Initialize this virtual computer system. */</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">  </span><span class="n">restart</span><span class="p">();</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="p">}</span>
</code></pre></div></p>
<p>第一项工作就是将一个内置的客户程序读入到内存中.直接就用了<code>memcpy</code>这个函数，明快。
注意：
<code>RESET_VECTOR</code>是存放代码的固定内存地址。由于本次实验采用<code>RISC-V</code>,内存地址不从零开始，所以要用<code>guest_to_host()</code>函数来转换。
它将CPU要访问的内存地址转化成数组pmem中的偏移位置。
<code>init_isa()</code>的第二项任务是初始化寄存器, 这是通过restart()函数来实现的.它设置<code>cpu.pc</code> 的值并将0号寄存器置0.</p>
<h3 id="_14">题目回答 注意事项<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p><strong>在<code>cmd_c()</code>函数中, 调用<code>cpu_exec()</code>的时候传入了参数-1, 你知道这是什么意思吗?</strong></p>
<p>看函数参数。是<code>uint_32t</code>类型的，是无符号整数。-1被看做无符号数，也就是2的32次方-1，就是运行这么多次。</p>
<p>表达式求值测试这里：</p>
<p><strong>如何过滤除以零的表达式?</strong></p>
<p>gcc 在编译的时候就会对除以0的表达式发生警报。在编译选项中加入<code>-Werror</code>将警告视作错误即可过滤。</p>
<p><strong>如何获得无符号数的运算结果?</strong></p>
<p>c语言默认数字是有符号的，在数字后面加<code>u</code>表示无符号数，如<code>12333u</code>。</p>
<p><strong>我加入了逻辑运算通不过测试可能是什么原因？</strong></p>
<p>注意C语言中， "||" 和 "&amp;&amp;" 是短路操作。你实现了吗？</p>
<p><strong>负号怎么实现?</strong></p>
<p>这里提供思路: 负号的识别看讲义. 负号的计算利用这个特征: 单元运算符只与最近的表达式(只能是括号或者是数字)相结合. 利用这个特点, 我考虑用栈, 若碰到单元运算符, 将之放入栈中. 另外再维护一个栈来记录下与这些单元运算符结合的括号或者数字的位置. 在递归出口时, 若是括号或者数字的情况, 比较该表达式所在位置和先前记录位置, 若相等, 说明栈中的运算符都是属于这个表达式的. 然后将运算符栈清空计算同时位置栈并弹出一个元素. 对了, 注意括号的情况. 有括号时, 将括号也压入栈, 弹出时弹到括号为止. </p>
<p>表述能力有限, 多包涵. 该思路本身有些麻烦, 不过通过了一些测试. 希望有更简单的思路.</p>
<p>做完PA1，你应该已经实现了一个简易的调试器。</p>
<h2 id="pa2">PA2<a class="headerlink" href="#pa2" title="Permanent link">&para;</a></h2>
<p>C 语言库函数源码</p>
<p><a href="https://stackoverflow.com/questions/5233514/where-to-find-stdio-h-functions-implementations">https://stackoverflow.com/questions/5233514/where-to-find-stdio-h-functions-implementations</a></p>
<p>上面是 glibc 的实现。有好奇过 printf 是怎么实现的吗？看看上面的链接吧。</p>
<p>孙燕姿的学会真好听啊，很治愈。</p>
<p>做这个 PA 实验花的时间比预想的久，一个是我学得慢，riscv 看了一天，然后 make 怎么用看了一天，基本上每天只能过一点点进度，一天做显卡，一天做声卡；但是确实很有收获的，之前很少有机会看这么多代码。最大的收获就是对计算机系统的把握吧。</p>
<p>PA 2 这个实验花了应该有 100+ 小时吧，陆陆续续写了两个星期了</p>
<p>下面就以问题为导向来整理好了。</p>
<h3 id="1-nemu">1. NEMU 中，一条指令是怎么完整执行的<a class="headerlink" href="#1-nemu" title="Permanent link">&para;</a></h3>
<p>好吧，就从这个必答题：一条汇编指令在 NEMU 中的执行过程开始说起。</p>
<p>只学过大计基的人也知道，指令的执行过程是取指、译码、执行，而 NEMU 正是这样的一个模拟器。</p>
<p>首先是开机， <code>nemu/src/monitor/monitor.c</code> 中做了各种初始化的工作</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">init_rand</span><span class="p">();</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">init_mem</span><span class="p">();</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">init_isa</span><span class="p">();</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="n">load_img</span><span class="p">();</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="n">IFDEF</span><span class="p">(</span><span class="n">CONFIG_DEVICE</span><span class="p">,</span><span class="w"> </span><span class="n">init_device</span><span class="p">());</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="n">welcome</span><span class="p">();</span>
</code></pre></div>
<p>然后，开始执行你的程序。 执行有关的代码都在 <code>nemu/src/cpu/cpu-exec.c</code> 中。我们一层一层看下去就知道了（用 GDB 调试更清楚）。执行一条指令的函数是 <code>exec_once()</code>，它做了什么呢。
先看一个数据类型吧，看这个 Decode 结构的定义
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Decode</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">  </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">  </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">snpc</span><span class="p">;</span><span class="w"> </span><span class="c1">// static next pc</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">  </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">dnpc</span><span class="p">;</span><span class="w"> </span><span class="c1">// dynamic next pc</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">  </span><span class="n">ISADecodeInfo</span><span class="w"> </span><span class="n">isa</span><span class="p">;</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">  </span><span class="n">IFDEF</span><span class="p">(</span><span class="n">CONFIG_ITRACE</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">logbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">]);</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="p">}</span><span class="w"> </span><span class="n">Decode</span><span class="p">;</span>
</code></pre></div>
包括 pc（当前指令）snpc 下一条动态指令 dnpc 下一条静态指令</p>
<p>这个结构体存储了 <code>pc</code> 的信息。于是我们就这样更新 cpu.pc 这个程序计数器
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">s</span><span class="o">-&gt;</span><span class="n">snpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">isa_exec_once</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="n">cpu</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dnpc</span><span class="p">;</span>
</code></pre></div>
然后在 isa_exec_once 中就是具体的 <strong>取指译码执行</strong>操作了。具体的代码在 <code>nemu/src/isa/riscv32/inst.c</code> 中。</p>
<h4 id="_15">取指<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>首先要取指。 <code>s-&gt;pc</code> 存储了当前要执行的指令地址，从这个地址读取指令。具体来说是这样，在NEMU中, 有一个函数 <code>inst_fetch()</code> (在 <code>nemu/include/cpu/ifetch.h</code> 中定义)专门负责取指令的工作.  <code>inst_fetch()</code> 最终会根据参数len来调用 <code>vaddr_ifetch()</code> (在 <code>nemu/src/memory/vaddr.c</code> 中定义), 而目前 <code>vaddr_ifetch()</code> 又会通过 <code>paddr_read()</code> 来访问物理内存中的内容. 因此, 取指操作的本质只不过就是一次内存的访问而已.</p>
<p>另外， <code>isa_exec_once()</code> 在调用 <code>inst_fetch()</code> 的时候传入了 <code>s-&gt;snpc</code> 的地址, 因此 <code>inst_fetch()</code> 最后还会根据 <code>len</code> （即指令长度）来更新 <code>s-&gt;snpc</code> , 从而让 <code>s-&gt;snpc</code> 指向下一条指令. </p>
<h4 id="_16">译码<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>然后译码。接下来代码会进入 <code>decode_exec()</code> 函数, 来进行译码。译码，顾名思义就是翻译取出的指令，看对应的操作是什么。</p>
<p>在 NEMU 中，译码是通过模式匹配来实现的。要实现匹配，又定义了一个非常精妙的宏 <code>INSTPAT</code> 来定义。</p>
<p>格式是这样</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>INSTPAT(模式字符串, 指令名称, 指令类型, 指令执行操作);
</code></pre></div>
<p>例子如下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">INSTPAT_START</span><span class="p">();</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">INSTPAT</span><span class="p">(</span><span class="s">&quot;??????? ????? ????? ??? ????? 00101 11&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">auipc</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">);</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="n">INSTPAT</span><span class="p">(</span><span class="s">&quot;0000000 00001 00000 000 00000 11100 11&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ebreak</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">NEMUTRAP</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">(</span><span class="mi">10</span><span class="p">)));</span><span class="w"> </span><span class="c1">// R(10) is $a0</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="n">INSTPAT</span><span class="p">(</span><span class="s">&quot;??????? ????? ????? ??? ????? ????? ??&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">INV</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">));</span><span class="w"> </span><span class="c1">// invalid inst</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="c1">// ...</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="n">INSTPAT_END</span><span class="p">();</span>
</code></pre></div>
<p>如果你的指令满足某一条匹配规则，那么我们就可以根据这个规则将一串二进制 01 翻译成对应的执行操作了。</p>
<h4 id="_17">执行<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>译码完成了以后，相应的动作都是用 C 语言模拟的，我们执行这些动作就可以了。</p>
<h4 id="pc">更新 PC<a class="headerlink" href="#pc" title="Permanent link">&para;</a></h4>
<p>上面执行完了以后，回到 <code>exec-once</code> 函数， 更新 pc 就结束了。</p>
<p>再之后的代码，就是打印出取到的指令的 16 进制表示及其反汇编结果的；源码很清楚，就不多说了，自己看吧。</p>
<details open="open">
<summary>tips</summary>
<p>宏定义太复杂了，要绕晕了怎么办呢？编译器可以帮助我们。gcc 加 <code>-E</code> 选项可以只打印展开结果而不编译。</p>
<p>有两个宏定义的结构体，展开了就很清晰了：
一个就是存储寄存器和 PC 的情况，还有一个就是用来存储指令的结构体</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">word_t</span><span class="w"> </span><span class="n">gpr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">  </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="p">}</span><span class="w"> </span><span class="n">riscv32_CPU_state</span><span class="p">;</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="p">}</span><span class="w"> </span><span class="n">riscv32_ISADecodeInfo</span><span class="p">;</span>
</code></pre></div>
</details>
<p>根据 riscv 指令来一条条添加匹配规则，这就是 PA2 的第一部分了。这里就体现了 riscv 的优越性，只需要添加大约 40 条指令就可以通过所有的测试了，这是 x86 想都不敢想的事情。</p>
<p>上面就是一条指令完整的执行结果了。</p>
<h4 id="nemu">NEMU 是什么？<a class="headerlink" href="#nemu" title="Permanent link">&para;</a></h4>
<p>NEMU 是一个模拟器，它模拟了真实计算机的硬件，从执行指令的 CPU 、内存到后面显卡、声卡等外设，都可以被它模拟出来。</p>
<h3 id="2-am">2. AM 是什么？运行时环境是什么？<a class="headerlink" href="#2-am" title="Permanent link">&para;</a></h3>
<p>我写了一个 C 程序，要在 NEMU 上运行，怎么运行呢？我们要为程序提供它需要的运行时环境。运行时环境是一个抽象的概念，可以理解成“程序运行所需的各种需求的满足”。</p>
<p>在上一部分中我们实现了四十多条指令，意味着我们可以进行各种计算了，我们实现了一个“图灵机”。“图灵机”就是最简单的运行时环境：内存，结束运行的方式和运算的指令。</p>
<p>然后呢，如果我的程序的需求更多呢？它不满足于运算，它想要打印，它想要显示，想要接受键盘输入，等等，怎么办？我们要为它提供更丰富的运行时环境。</p>
<p>于是 AM 就应运而生了。AM 是一个为应用程序提供各种运行时环境的库。</p>
<p>AM 将程序运行的需求都收集起来，抽象成了统一的 API，应用程序有需求，直接调用对应的 API 就可以了。</p>
<p>其实，你也可以说，应用程序干嘛非得调库呢？我有需求，我自己码代码实现不可以吗？比如说，我想操控硬件，那我就直接写对硬件读写的代码呗，不行吗？</p>
<p>实际上，当然是可以的。但是，这样不麻烦吗？所以，AM 存在的最大意义就是为了抽象，而抽象是为了简单。我抽象出来，让应用程序不必关注底层的硬件，专注于实现自己的功能就可以了。</p>
<p>所以，原本的软硬件关系是这样的：
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>NEMU -&gt; 应用软件层
</code></pre></div>
NEMU 提供硬件功能；应用软件直接执行，直接和硬件交互</p>
<p>现在增加了一层 AM 抽象层：
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>NEMU -&gt; AM 抽象层 -&gt; 应用软件层
</code></pre></div>
NEMU 提供硬件功能；AM 抽象层负责和上层的软件和底层的硬件进行交互，屏蔽掉交互细节，只提供抽象接口给应用软件层；应用软件层不直接操纵硬件，只和 AM 抽象层进行交互。</p>
<p>AM 中的 API，帮助实现了程序需要的运行时环境，于是将这些 API 称作 abstract machine，这就是 AM 库名称的由来。调用了这些接口的程序，称为 AM 程序。细细理解也是，这些接口实现，很像一个为程序运行提供各种东西的计算机。AM 库包含下面部分：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>AM = TRM + IOE + CTE + VME + MPE
</code></pre></div>
<p>TRM 提供计算功能，IOE 提供输入输出功能，其他的还未涉及。</p>
<p>(2024年3月26日) 感觉自己上面有点啰嗦. 其实就是因为直接和硬件交互太麻烦了, 所以事先写好和硬件交互的函数再调用就不用这么麻烦每次都从零开始写了, AM 就是为了方便而产生的. </p>
<h4 id="_18">具体实现<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>运行时环境可以分为架构相关和架构无关。io 就是典型的架构相关的，不同 isa 对应的底层硬件不同，所以对每一种架构都要写一个对应的函数。还有一些库函数是架构无关的，一个实现就可以给所有的架构用了。</p>
<p>实现库函数这里都是苦力活，没什么好说的。就一个 bug 需要提一提，在实现 <code>strcmp</code> 的时候发现的，关于 <code>char</code> 的 bug。</p>
<ol>
<li><code>char</code> 在编译时居然是默认被解释为无符号类型的，即 <code>unsigned char</code>。应该是交叉编译导致的，因为 x86 的下编译是解释为有符号类型的（等待 difftest 验证）。解决方法是使用 <code>int8_t</code> 来明确类型。</li>
<li>8 位无符号数相减得到的却是有符号数，然而结果用 (int) 扩展到 32 位后结果又变成了无符号数。这个特性不管是 x86 还是 riscv 都有。解决方法就是小心一点多做一步强制类型转换。
    我现在发现这其实不是什么 bug，是这样的原因：有符号数和无符号数做运算（双目运算符的两边）时会转化为无符号数，所以在 a=1，b=2时，a-b==-1 和 a==-1u 都成立 这是因为 -1 被转化成了无符号数。</li>
<li>所以 <code>&lt;stdint.h&gt;</code> 规避了很多歧义，建议使用。</li>
</ol>
<h3 id="3-am-nemu">3. AM 程序怎么构建，怎么在 NEMU 中运行？<a class="headerlink" href="#3-am-nemu" title="Permanent link">&para;</a></h3>
<p>讲义值得参考的部分：<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2023/2.3.html#rtfsc3">https://nju-projectn.github.io/ics-pa-gitbook/ics2023/2.3.html#rtfsc3</a> </p>
<p>可以问一个更加具体的问题：在<code>am-kernels/kernels/hello/</code> 下运行 <code>make ARCH=$ISA-nemu run</code>，make 到底做了些什么呢？</p>
<p>先看 AM 程序是怎么构建的吧。看 AM 的 Makefile 源文件，我可以看出来编译和链接的代码，并且可以根据 <code>ARCH</code> 这个命令行参数来选择不同的架构。选择的架构不同，就会选择不同的交叉编译工具，编译不同架构的代码。如果选择的架构是<code>native</code>，就直接用 gcc 编译成 <code>x86</code> 类型的文件，可以直接在 linux 主机上运行；如果选择的是<code>riscv32-nemu</code>，就会用riscv64-linux-gnu-gcc 来编译，并进行进一步处理，来使得程序可以在 nemu 上运行。</p>
<details class="小问题" open="open">
<summary>小问题</summary>
<p>问题：我目前还没有搞清楚在 Makefile 中怎么规定编译链接的顺序。</p>
<p>勉强答：编译的先后顺序无所谓，链接的顺序是 ld 根据链接脚本 <code>abstract-machine/scripts/linker.ld</code> 来链接，but 这个文件我还是看不懂。</p>
</details>
<details class="交叉编译" open="open">
<summary>交叉编译</summary>
<p>什么是交叉编译呢？在一个平台上将代码编译成另一个平台的程序就叫交叉编译。比如我们这里，就是在 <code>x86</code> 的 linux 平台下把代码编译成 <code>riscv32</code> 类型的文件。</p>
</details>
<p>如果要搞清楚 make 在做什么的话，可以利用 make 的 -n 选项来查看运行 make 会执行哪些命令。这里我们运行</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>make -n ARCH=riscv32-nemu run
</code></pre></div>
<p>输出的结果很长，我就不放了。
做的事情概括起来是：</p>
<ol>
<li>gcc 将 AM 实现源文件编译成目标文件，用 ar 将目标文件打包成一个库</li>
<li>通过 gcc 和 ar 将 klib 的实现编译打包成库</li>
<li>gcc 把应用程序源文件 <code>hello.c</code> 编译成目标文件</li>
<li>用 ld 根据链接脚本 <code>abstract-machine/scripts/linker.ld</code>, 将上述目标文件和归档文件链接成可执行文件，<code>*.bin</code>是镜像文件，将加载到 nemu 中运行，<code>*.elf</code> 是对应的 16 进制文件，我们可以读取它获得相应的信息。</li>
<li>run 选项对应的代码是 <code>$(MAKE)i-C $(NEMU_HOME) ISA=$(ISA) run ARGS="$(NEMUFLAGS)" IMG=$(IMAGE).bin</code>。很简单，是在 nemu 的主文件夹下编译构建出 nemu interpreter，并运行它。</li>
</ol>
<p>接着，nemu 运行它的应用程序的过程：</p>
<ol>
<li>打开 nemu 以后，nemu 在初始化的过程中会将即将执行的应用程序的镜像文件 (*.bin) 加载到内存 (pmem) 中。</li>
<li>开始运行程序后，第一条指令从 <code>abstract-machine/am/src/$ISA/nemu/start.S</code> 开始, 设置好栈顶之后就跳转到 <code>abstract-machine/am/src/platform/nemu/trm.c</code> 的 <code>_trm_init()</code> 函数处执行.</li>
<li>在 <code>_trm_init()</code>中调用 <code>main()</code> 函数执行程序的主体功能</li>
<li>从 <code>main()</code> 函数返回后, 调用 <code>halt()</code> 结束运行</li>
</ol>
<details class="小问题" open="open">
<summary>小问题</summary>
<p>问题：编译构建 nemu 项目时，最后的项目名称 <code>nemu-intepreter</code> 哪里来的？我还没搞清楚。</p>
</details>
<h3 id="4-io">4. IO 设备<a class="headerlink" href="#4-io" title="Permanent link">&para;</a></h3>
<p>NEMU 是怎么实现输入输出设备的模拟的？</p>
<p>看一看源码，一个设备是怎么注册的。首先规定好设备的大小，给设备接口分配一个所需的大小的空间（用 malloc 即可），然后规定好设备的映射地址，以及相应的回调函数，最后将空间、地址和函数等信息通过初始化函数存储起来，就完成了注册。</p>
<p>如果我注册了一个设备，当我访问这段物理地址的时候，就会跳转到对应 I/O 设备地址（就是上面 malloc 分配的额外的空间，而不再是 pmem 内存中了）。当我对这段地址读写时，可能会触发相应的回调函数，回调函数就是这个设备的“动作”了。比如串口的回调函数，就是打印写入的字符到标准错误流中。</p>
<p>更具体的，就 RTFSC 吧，源代码还是比较清楚的，讲义也很详细了： <a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2023/2.5.html">https://nju-projectn.github.io/ics-pa-gitbook/ics2023/2.5.html</a></p>
<h4 id="_19">声卡<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p>最麻烦的就是声卡，需要软件硬件协同操作。</p>
<p>但是学到的也最多，实现了声卡了以后，理解就更深刻，在 AM 中寄存器的操作都还是软件层，AM 就是软件和硬件的桥梁，将相应的数据写到对应的内存中，然后硬件（NEMU）再进行处理，进行声音的播放。看到完整的 bad apple 还怪高兴的哈哈。</p>
<p>打开声卡前，最好关闭 trace 功能。</p>
<p>声卡很吃配置，打开声卡以后，超级玛丽完全玩不了了。（显卡还有十几帧的）。</p>
<p>另外，不要老是挂起虚拟机。正常的指令执行速度是每秒两千万条，有的时候性能降低到每秒八万条，打字都卡，就赶紧关机重启吧。</p>
<p>二次元是这样的：
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>................................................................................
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>..............................................X.X.X.............................
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>.............................................XXXXXXXXX..........................
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>..............................................XXXXXXXXX.XXXXX...................
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>............................................XXXXXXXXXXXXXXXXXXX.................
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>........................................X.XXXXXXXXXXXXXXXXXXXXX.................
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>........................................XXXXXXXXXXXXXXXXXXXXXXXX................
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>........................................XXXXXXXXXXXXXXXXXXXXXXXXX...............
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>.......................................XXXXXXXXXXXXXXXXXXXXXXXXXXX..............
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>........................................XXXXXXXXXXXXXXXXXXXXXXXXXXX.............
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>...........................................XXXXXXXXXXXXXXXXXXXXXXXX.............
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>............................................XXXXXXXXXXXXXXXXXXXXXXX.............
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>.............................................XXXXXXXXXXXXXXXXXXXXXX.............
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>..............................................XXX.XXXXXXXXXXXXXXXXX.............
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>..............................................XXXXXXXXXXXXXXXXXXXXXX............
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>........................X.X.X.X...............XXXXXXXXXXXXXXXXX.X.X.............
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>.......................XXXXXXXXX...............XXXXXXXXXXXXXXXX.................
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>......................XXXXXXXXXXX...........X.XXXXXXXXXXXXXXX.X.................
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>.......................XXXXXXXXXXX.X.......XXXXXXXXXXXXXXXXXXX..................
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>........................XXXXXXXXXXXXXXX.X.XXXXXXXXXXXXXXXXXXXX..................
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>.............................XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX..................
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>............................XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...X.X...........
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>.............................XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.X............
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>............................XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...............
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>............................XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX..............
</code></pre></div></p>
<h3 id="5">5. 杂项<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>ftrace 真的是要老命了，纯苦力活。</p>
<p>读取 ELF 文件？问互联网、问手册、问 GPT 吧。简单的说，利用 <code>fread</code> <code>fseek</code> 将文件里的信息读取到 <code>&lt;elf.h&gt;</code> 中定义的结构体里面，就成功了。<em>我会不会简单介绍一下 ELF 的结构呢？会的。</em></p>
<p>怎么判断 riscv 中何时 call、何时 ret？call 和 ret 都会离开当前函数体。先判断 call，如果下一条指令地址是一个函数头，就一定是 call，反之就是 ret。</p>
<p>而且 ftrace 做完以后还引入一个新 bug：我关闭调试信息选项以后，编译不通过了是几个意思？？？（其实可以理解，因为关闭调试选项意味着没有了任何信息，导致读入的都是无效的字符，所以导致编译器报未初始化警告）</p>
<p>想尽可能把实验的记录写清楚点，但是真的太花精力了，睡觉！</p>
<p>然后还有一点，NEMU 的性能真的很低，不要期望可以流畅运行多好的程序。</p>
<p>上面的NEMU只能运行一个程序。如何实现多程序同时运行？虚拟内存：PA4 的内容</p>
<h3 id="6-makefile">6. makefile 的各种问题<a class="headerlink" href="#6-makefile" title="Permanent link">&para;</a></h3>
<ol>
<li>mainargs 是怎么传参到程序的。我遭遇了 bug，前几天能成功传参的，现在突然不行了.</li>
<li>https://www.cnblogs.com/nosae/p/17066439.html#%E7%90%86%E8%A7%A3mainargs</li>
<li>别人直接都把答案写在博客里了，还是要自己独立完成啊。</li>
<li>CFLAGS += -DMAINARGS=\"$(mainargs)\"  $AM_HOME/scripts/platform/nemu.mk</li>
</ol>
<h2 id="pa3">PA3<a class="headerlink" href="#pa3" title="Permanent link">&para;</a></h2>
<h3 id="pa31">PA3.1<a class="headerlink" href="#pa31" title="Permanent link">&para;</a></h3>
<p>PA3.1 主要讲的是异常，这里如笼统地将中断和异常两个概念混为一谈，
那么这个概念在单片机中已经学过，可以很不准确地将之理解为另外一种“函数”的调用。</p>
<p>为了支持异常，riscv 是引入了特权级指令（ecall/mret/csrrw/csrrc 等等）和控制状态寄存器 CSR（mepc/mstatus/mcause/mtvec 等等）。为了实现异常，硬件层面要额外加上这些指令和寄存器。</p>
<h4 id="_20">处理异常的过程<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>然后看看处理“异常” 究竟发生了什么吧。</p>
<p>在我使用了 <code>ecall</code> 自陷指令来主动发生异常后，硬件层面所做的事情如下：</p>
<ol>
<li>将当前PC值保存到mepc寄存器</li>
<li>在mcause寄存器中设置异常号</li>
<li>从mtvec寄存器中取出异常入口地址</li>
<li>跳转到异常入口地址</li>
</ol>
<p>然后就对异常进行处理，首先要保存原程序的状态，然后再进行下一步操作，比如在单片机中可以进行一次 AD/DA 的操作，在操作系统中可以处理错误等等。根据异常的种类来决定是否返回源程序。</p>
<p>如果返回原程序，那么就先恢复原程序的状态，然后使用 <code>mret</code> 指令，取出 mepc 中的地址放入 pc 中，从异常状态中返回。</p>
<p>程序的状态，更确切的说，可以用“上下文（context）”这个概念描述。AM 也有上下文管理的 API，名为 CTE。上下文管理主要需要两个信息，一个是触发异常的事件 event，还有就是程序的上下文 context 了。程序的上下文包括各种寄存器的信息。CTE 的各种 API 都在 <code>cte.c</code> 中，包括 <code>cte_init</code>，<code>__am_irq_handle</code>，<code>yield</code> 等等。 </p>
<h4 id="yield-test">yield test 发生了什么<a class="headerlink" href="#yield-test" title="Permanent link">&para;</a></h4>
<p>上面说完了异常处理的过程，那么下面就回答一下一个必答题：在 yield test 中究竟发生了什么事情？</p>
<p>首先是在 <code>cte_init</code> 函数中初始化。这个函数做两件事情：1. 在 mtvec 寄存器中设置异常入口地址，2. 设置回调函数（异常处理函数）。注意这句代码：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;csrw mtvec, %0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">__am_asm_trap</span><span class="p">));</span>
</code></pre></div>
<p>也就是说，异常向量 mtvec 的地址就是 <code>__am_asm_trap</code> 这个函数的入口。</p>
<p>然后经过一些无关紧要的操作后，调用 <code>yield</code> 函数。<code>yield</code> 函数里面就是内联汇编代码，使用 <code>ecall</code> 指令来进行自陷操作。<code>ecall</code> 指令让程序跳转到异常入口，即 <code>__am_asm_trap</code> 的起始地址。<code>__am_asm_trap</code> 是 <code>trap.S</code> 中的汇编代码。做的事情其实就是把寄存器信息压入到栈中保存，然后进入 <code>__am_irq_handle</code> 这个函数中，调用之前的初始化设置的回调函数，完成异常处理（这里就是打印 y 这个字符），然后回去恢复寄存器信息，最后 <code>mret</code> 回到原来的位置，就完成了一次异常处理。因为是在一个无限循环中，所以会不断的打印 y。如果没有在循环中, 那打印一次 y 程序就结束了.</p>
<p>yield test 就这样走完了它的全过程。</p>
<p>等等，还有一件事！<code>__am_irq_handle</code> 中上下文结构体指针 <code>c</code> 是什么时候来的，什么时候赋值的？都走完了也没见它的踪影啊。</p>
<p>如果只看 C 语言代码的话，是永远也找不到答案的。答案在汇编代码 <code>trap.S</code> 中。<code>__am_irq_handle</code> 是在 <code>trap.S</code> 中被调用的。汇编语言的函数参数是怎么确定的呢？关键就是调用函数前一句代码，<code>mv a0, sp</code>，这是汇编语言的传参。看一下 riscv 的手册也可以知道，<code>a0</code> 寄存器储存函数的第一个参数。<code>__am_irq_handle</code> 的第一个参数就是结构指针 <code>c</code>，所以传入的参数就是栈地址 <code>sp</code>。<strong>结构体有这样的性质：如果某个地址开头正好是结构体的地址，并且写入顺序和结构体的定义顺序一致，那么就相当于向一个结构体写数据</strong>。所以，赋值的过程，在我们将寄存器压入内存的时候就已经完成了。这就是这个问题的答案，也是 PA 的其中一个问题，要求我们按规定的顺序来定义 context 结构体的原因。</p>
<p>总结：PA3.1 主要的坑一个是内联汇编不熟悉，还有一个是汇编语言已经忘记得差不多了，所以完全没有看出来 <code>mv a0, sp</code> 是函数参数的赋值。非常感谢：<a href="https://www.cnblogs.com/GrootStudy/p/17039807.html">https://www.cnblogs.com/GrootStudy/p/17039807.html</a> 给了我很大的启发。</p>
<h3 id="pa-32">PA 3.2<a class="headerlink" href="#pa-32" title="Permanent link">&para;</a></h3>
<p>PA 3.2 主要的任务是实现了系统调用，然后可以用 nanos-lite 这个简单的批处理系统加载一些应用程序。</p>
<p>要实现上面的功能，首先就是要先将应用程序加载到对应的内存中。这里我想到一个小问题，为什么 NEMU 内存可以直接通过绝对地址访问？比如 "0x83000000" ？</p>
<p>这个问题其实挺简单的。一般来讲代码里的变量、数组的地址都是通过编译器来分配的。但你直接写一个绝对地址，访问这个地址也是可以的，最后编译器转化成底层的汇编代码后，那些底层的汇编代码就会访问你写的绝对地址。<code>paddr_read</code>、<code>paddr_write</code> 这些函数都是在模拟汇编指令的时候调用了。</p>
<p>然后就是实现系统调用了，首先对 AM 进行一些修改，使得我们的批处理系统能够分辨是自陷事件还是系统调用事件，然后根据不同的系统调用，进行底层的 AM 实现就可以了。我们现在实现的系统调用有：yield 调用进入自陷，write 调用进行输出，exit 调用退出程序，sbrk 调用分配内存等。</p>
<p>下面我们就完完整整地讲解一下 hello 这个测试程序的来龙去脉吧。目前我也还有些没完全搞清楚，期待补充。</p>
<p>首先得解释一下，navy 项目中的程序都是依赖于 newlib 库来运行的，newlib 是一个为嵌入式系统提供的 C 库。hello 程序中的 printf 函数可能与 AM 项目中的函数重名，但是具体的实现是在 newlib 中实现的，并且逻辑也不同。下面会详细说明。</p>
<p>用户程序从哪里开始的呢？好吧我承认我没看仔细讲义里有的。用户程序的入口位于 <code>navy-apps/libs/libos/src/crt0/start.S</code> 中的 <code>_start()</code> 函数，<code>_start()</code> 函数会调用 <code>navy-apps/libs/libos/src/crt0/crt0.c</code> 中的 <code>call_main()</code> 函数, 然后调用用户程序的 <code>main()</code> 函数， 从 <code>main()</code> 函数返回后会调用 <code>exit()</code> 结束运行。怎么跳转到用户程序的入口呢？ Nanos-lite 在加载好用户程序后，返回用户地址入口 <code>entry</code>，然后 <code>((void (*)())entry)();</code> 就跳转了。</p>
<p>hallo 程序中涉及了上面除了 yield 外所有的系统调用。首先是 <code>write</code> 函数，查看一下 <code>write</code> 函数的源代码就知道，<code>write</code> 调用了 <code>_write_r</code> 函数，<code>_write_r</code> 函数调用了 <code>_write</code> 函数，<code>_write</code> 函数调用了我们的系统函数 <code>_syscall_</code>。上面都是应用程序层面的实现，一直到 <code>_syscall_</code> 才到底层的实现。<code>_syscall_</code> 函数将异常状态号和输入参数设置好以后，就执行 <code>ebreak</code> 指令，<code>ebreak</code> 指令跳转到之前设置的异常入口地址 <code>__am_asm_trap</code>，然后是 <code>__am_irq_handle</code>，然后是回调函数 <code>do_event</code>，<code>do_event</code> 识别是 <code>syscall</code> 类型的事件，然后执行 <code>do_syscall</code> 函数，<code>do_syscall</code> 识别是 <code>write</code> 系统调用，执行 <code>sys_write</code> 函数，在这个函数里终于通过 <code>putch</code> 函数，将字符一个个输出到串口。</p>
<p>然后介绍 <code>printf</code> 函数。<code>printf</code> 的实现就非常复杂了。具体可以看这个链接：<a href="https://www.cnblogs.com/DF11G/p/14750056.html">https://www.cnblogs.com/DF11G/p/14750056.html</a>。可以简单的理解为，先通过 <code>sbrk</code> 系统调用获取内存，然后再通过上面讲解 <code>write</code> 系统调用输出。而 AM 中的 <code>printf</code>，本质上就是直接通过 <code>putch</code> 输出格式化的字符串。所以两者还是非常不同的。</p>
<p>程序结束后，就会通过 <code>exit</code> 函数退出。（原来的 hello 程序是死循环，我把循环改了）。exit() 函数层层跳转后，就是我们的 <code>exit</code> 系统调用。另外，我这里有一个 bug 没有解决，就是在调用 <code>printf</code> 函数后，系统的退出值就不是 0，但是可惜很难看出是哪方面的原因，但是总而言之，与我无瓜，因为即使是 <code>sbrk</code> 没有实现的情况下，结果也如此。更新：完成 PA3.3 的文件系统后，这个 bug 突然消失了，又可以完美退出了，可怕。</p>
<p>接下来我们来看一下 <code>sbrk</code> 系统调用吧。newlib 库中的 <code>malloc</code> 函数最终就是调用了 <code>_sbrk</code> 函数。比如我们可以看一下 libgross 库中 ARM 体系的实现。（libgross 是 newlib 库中自带的底层实现，但是可惜没有 PA 系统的底层实现，哈哈）</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">__attribute__</span><span class="p">((</span><span class="n">weak</span><span class="p">))</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">_sbrk</span><span class="w"> </span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">incr</span><span class="p">)</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="p">{</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;end&quot;</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Defined by the linker.  */</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">heap_end</span><span class="p">;</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w">        </span><span class="n">prev_heap_end</span><span class="p">;</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heap_end</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">    </span><span class="n">heap_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">  </span><span class="n">prev_heap_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_end</span><span class="p">;</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">heap_end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">incr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">stack_ptr</span><span class="p">)</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">      </span><span class="cm">/* Honour heap limit if it&#39;s valid.  */</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="w">      </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">__heap_limit</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xcafedead</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">heap_end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">incr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">__heap_limit</span><span class="p">))</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="w">      </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">  </span><span class="n">heap_end</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">incr</span><span class="p">;</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">prev_heap_end</span><span class="p">;</span>
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="p">}</span>
</code></pre></div>
<p>之前说没理解, 现在感觉没有什么不好理解的, 分配内存就是这么做的, (可能是写了好几次的关系). 另外, <code>&amp;end</code> 地址是程序数据段的末尾地址, 即堆区的起始位置, (去看一下程序结构里的图就明白了). 堆的内存边界通常被称为 program break. 调用 <code>sbrk()</code> 的过程, 就会更新 program break. (即上述代码中的 heap_end). 看下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/peter5723/imagehost/pa3.2.1.png"/></p>
<p>上面基本就是 PA3, part 2 了。总结一下，在 NEMU 硬件上，我们实现了 AM 接口，然后写了一个 AM 程序 nanos-lite，在 nanos-lite 上，我们运行应用程序。应用程序不能直接操控底层，而是通过系统调用来和底层交互（对应用程序来说，AM 也算是底层了，毕竟是直接和硬件交互的库）。</p>
<p>学而不思则罔，思而不学则殆，PA3.2 基本上完成了，但是一些关于程序的知识仍然不了解，比如堆的机制。系统调用的过程还需要好好理解，elf 文件的结构要整理了。PA3 和前面最大的区别就是多了一些我没学习过的理论知识需要补充吧。(补充, 这里说的问题基本都整理完毕 2024年3月30日)</p>
<h3 id="pa-33">PA 3.3<a class="headerlink" href="#pa-33" title="Permanent link">&para;</a></h3>
<p>PA3.3 首先是实现了一个简单的文件系统，实现了 open、read、write、lseek、close 系统调用，这样我们就可以进行文件操作了。在 linux 中，有一个说法是“一切皆文件”。这是因为 IO 接口也被抽象成文件了，我们进行 IO 的过程就被抽象成文件读写的过程，上层 API 无需改动，只要根据文件类型更改底层调用的读写函数就可以了。基于这个逻辑，我们很快就实现了操作系统的各种 IO 接口，比如输入输出，键盘，显存，时间等等。完成这些接口以后，我们就可以运行各式各样的应用程序了。</p>
<p>当然理论如此，实践的时候总会碰到各种各样的问题。比如说，一开始提供的多媒体库是 NDL 库，它的实现是直接进行系统调用。然而，对于较为复杂的程序，直接用它编程仍然比较难，所以我们要提供更加上层的运行时环境，这里就是 SDL 库，在 SDL 库的实现中调用 NDL 库。具体的编程过程就不细说了，有些繁琐，调试了很久才基本完全跑通，主要还是要仔细阅读手册和讲义内容。</p>
<p>上面都是一些概括，说一个稍具体些的例子吧。讲义里面有一个问题是：仙剑奇侠传的代码如何从 mgo.mkf 文件中读出仙鹤的像素信息, 并且更新到屏幕上?</p>
<p>仙剑奇侠传的代码很复杂，而且函数也是一层一层套的。但是到底层，调用的仍然是我们实现的 SDL 库函数来进行绘图和更新屏幕，<code>SDL_UpdateRect()</code>，这个函数调用的是 NDL 库的函数 <code>NDL_DrawRect()</code>。<code>NDL_DrawRect()</code> 调用 <code>write()</code> 函数，将像素数组 <code>pixels</code> 写入虚拟文件 <code>/dev/fb</code> （也就是帧缓冲 frame buffer）中。这是上层的内容，即应用程序看到的内容。</p>
<p>然后操作系统 Nanos-lite 看到的内容是，数据写入 <code>/dev/fb</code>，要调用对应的写函数。就 C 语言具体实现来说，利用函数指针就可以轻松地根据文件的类型来选择调用的函数了。那么这里的写函数是要更新屏幕的，所以调用 AM 程序的 IO 接口 <code>io_write()</code> 函数就可以了。</p>
<p>从硬件 NEMU 的角度看，调用 IO 接口，本质上还是对某一个地址进行读写操作。然而，不同的是，这些地址在底层实现上进行了映射。如果读写到这些地址，不是对真实的物理内存进行读写，而是对映射的 IO 地址进行读写。读写完后，新像素就更新到了屏幕上。</p>
<p>上面就是自顶向下的应用程序进行屏幕更新的全过程。</p>
<p>仙剑奇侠传运行：</p>
<p><img alt="" src="https://cdn.jsdelivr.net/gh/peter5723/imagehost/panote1.jpg" /></p>
<p>TODO: 搞清楚 native 和 riscv32-NEMU 的区别。（链接的库有哪些不同？）</p>
<p>TODO: open 和 fopen 的区别(文件系统)</p>
<p>TODO: malloc 和 free 的源代码实现。</p>
<h2 id="pa4">PA4<a class="headerlink" href="#pa4" title="Permanent link">&para;</a></h2>
<h3 id="pa41">PA4.1 多道程序<a class="headerlink" href="#pa41" title="Permanent link">&para;</a></h3>
<p>实现了命令行参数的传递, 内核进程和用户进程切换运行, 以及 busybox 来实现一些 shell 指令.</p>
<h3 id="pa42">PA4.2 分页<a class="headerlink" href="#pa42" title="Permanent link">&para;</a></h3>
<p>首先虚拟内存的知识点已经整理到了相应的博客里面.</p>
<p>实现了虚拟内存转物理内存. 首先是操作系统在启动时将相关信息写入内存(虚拟页到物理页的映射关系). 后面翻译时, 拿到一个虚拟地址, 只需将其所在的虚拟页转化成物理页, 就迎刃而解了, 因为页大小相同, 所以偏移量也是相同的.</p>
<p>其实虚拟内存还是挺简单的, 哈哈. 但是实际编写代码, 还是会碰到各种各样的问题.</p>
<p>PA4.2 调了 3 天 bug</p>
<p>碰到的 bug 如下:</p>
<ol>
<li>bss 段忘记清零</li>
<li>将程序写入物理页时, 没有考虑偏移的情况(即程序段的虚拟地址并不是从页开始, 那么写入物理段时也应当有一个偏移).</li>
<li>最愚蠢的. 有时调试要切回 PA4.1, 那个时候程序是链接到 0x8300 0000 的, 而完成虚拟内存后, 链接到的地址是 0x4000 0000 的. 然后切回 PA4.2 的版本, 忘记 make update 了, 结果还是跑老程序. 而 0x8300 0000 的部分是会被分配出去的, 数据会被修改, 就会导致错误.</li>
<li>现在执行新程序(如用 nterm 打开仙剑奇侠传)会导致错误(我一开始还以为是环境变量的问题). (PS, 不要让 Hello 打印居然就不会引发错误). 看了一下, 是 PA4.3 的内容, 到那时去探究.</li>
</ol>
<h3 id="pa-43">PA 4.3 栈切换<a class="headerlink" href="#pa-43" title="Permanent link">&para;</a></h3>
<details class="note">
<summary>Note</summary>
<p>时钟中断很简单就不展开讲了.</p>
</details>
<p>首先要回答上面的问题 4, 为什么执行新程序, 或者两个用户进程同时运行会导致错误. 这是因为目前为止, 在触发异常时, 我们都是将上下文储存在用户栈上的. 这就导致了切换上下文时我们储存在 PCB 中的地址是虚拟地址. 举个例子, 假设我们是要从进程 A 切换到进程 B. 切换完的第一步就是要 __am_switch(cB), 将 satp 设置成 cB.pdir. 然而, 我们现在还在 A 的虚拟地址空间中, 只能按照 A 的规则转换 cB 的虚拟地址, 这就导致了我们无法找到真正的 cB.pdir, 再后面, 对进程 B 的地址转换也就无从谈起了.</p>
<p>假设是内核线程 A 和用户进程 B 同时运行, 再由 B 打开 C, 也会碰到类似的错误. 在切换到 C 时, satp 不是 C 的地址空间, 因此无法正确映射.</p>
<p>要解决上面问题的方法, 其实说起来非常简单(注意: "说起来"和实现总是有差的): 在保存上下文时, 将上下文储存在内核栈上. 这样, 储存在 PCB 中的上下文的地址均是实际的物理地址, 也就不存在映射不映射的问题了.</p>
<p>具体的实现, 参照讲义的伪代码就可以了:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">__am_asm_trap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ksp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// ksp is global</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">usp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$sp</span><span class="p">;</span><span class="w">   </span><span class="c1">// usp should be in Context</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="n">$sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ksp</span><span class="p">;</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">  </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ksp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">KERNEL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">USER</span><span class="p">);</span><span class="w">  </span><span class="c1">// np should be in Context</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">  </span><span class="n">ksp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">          </span><span class="c1">// support re-entry of CTE</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">  </span><span class="c1">// save context</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="w">  </span><span class="n">__am_irq_handle</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">  </span><span class="c1">// restore context</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">np</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">USER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">    </span><span class="n">ksp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$sp</span><span class="p">;</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="w">    </span><span class="n">$sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">usp</span><span class="p">;</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="w">  </span><span class="n">return_from_trap</span><span class="p">();</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a><span class="p">}</span>
</code></pre></div>
<p>碰到的 bug 如下:</p>
<ol>
<li>写完栈切换的汇编代码后, 发现内核和用户栈切换会导致错误. 最后 sp 的值是 fffffffx 这个问题是内核 Context 没有初始化, 所以返回后 sp 变为 0, 下次调用函数时减去某个值, 就得到上面那个不合法地址了.</li>
<li>用户栈之间切换导致错误. 选择两个最简单的进程, 只打印某些字符. 但是每次或是打印错误的字符, 或是直接错误. 并且逐步调试, 错误的地方都是 serial_write 函数. 并且, yield 放在 putch 之前就会报错, 然而之后就不会, 所以是 yield 触发异常之后导致了某些问题. 再进行逐步调试, 比较两种情况下的 yield 触发前和触发后的情况, 发现是地址映射寄存器 satp 改变了. 所以是 satp 的问题, yield 以后 satp 没有变回来, 导致后面的地址映射错误. 问题是在 am_irq_handle 中没有保存 satp 的值. 现在实现了栈切换, 无脑保存即可. 修改逻辑以后, 就可以成功运行两个用户进程了.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/peter5723/imagehost/pa4.3.1.jpg"/></p>
<p>上面是 Hello 线程和仙剑奇侠传的线程同时运行.</p>
<p>最后是台前调度的功能, 本来以为完不成了, 没想到我居然这么聪明, 看出了问题所在啊. 首先, 明面上的现象是, 程序能否正确运行居然是和 init_proc 函数中 context_uload 的顺序有关, 只有前台程序 (fg_pcb) 恰好是最后一个 context_uload 的才能正确运行. 但是理论上说, 程序加载进不同的 PCB, 当然都可以使用, 和加载顺序当然是无关的. 这是一个很匪夷所思的问题, 直接思考可能会想是否是后面的 PCB 会否覆盖了前面的 PCB. 但是, 排查了一下, 似乎很难验证这种现象. </p>
<p>所以, 要找错误, 就要开始调试. 打开 NEMU 的 trace, 发现不管是前面的情况, 还是正确运行后更改进程, 错误的地方都是 am_asm_trap 中 mret. 在 mret 后, 原本能解码的虚拟地址突然就不能解码了. 因为都是在内核中出问题, 并且返回地址是虚拟地址, 这意味着是应用程序申请系统调用时出了问题. 打开 strace, 发现都是在 9 号调用中出的问题, 而 9 号调用是 brk, 内存申请调用. 内存申请调用时, 唯一可能修改虚拟地址的映射的, 就是 mm_brk 中的 map 函数. 之前一直正确的 map 函数能出问题, 的确没有想到. 看一下它的逻辑, 是物理地址连续时, 能正确映射, 然而不连续就会覆盖前面的地址表. 所以就导致了为什么最后一个程序能正确运行, 因为地址映射是连续的. 修改了 map 函数的错误逻辑以后, 就可以开心滴进行前台调度了. </p>
<p>其实调试的过程虽然很煎熬, 而且往往排查一下午甚至一天, 最后导致错误的, 只是一小句代码. 但是逻辑推理的过程, 由现象找到本质, 找到精确的错误点, 并解决它, 是非常有成就感的. </p>
<p>如下图所示, 切到 bird 游戏后又切到仙剑奇侠传.</p>
<p><img src="https://cdn.jsdelivr.net/gh/peter5723/imagehost/pa4.3.2.jpg"/></p>
<!-- PA4 必答题, 很简单我就不写了. 可以看这个网站: https://kristoff-starling.github.io/posts/coursenotes/nju-ics/pa/pa4/ -->

<p>必答题：最后总结一下，仙剑奇侠传怎么同时和 hello 用户程序分时运行？</p>
<p>以 hello 程序切换为例：每一条指令结束，NEMU 的 cpu_exec() 函数会检查 CPU 的 INTR 引脚是否被拉高，是则有时钟中断请求，若此时 CPU 允许中断，则会进入设置好的中断处理程序 trap.s。在其中，nanos-lite 会将 hello 进程的上下文保存到内核栈中，进入 __am_irq_handle() 函数，调用之前的回调函数 do_event()，再到 schedule() 函数切换到仙剑奇侠传进程的上下文。回到 trap.s 恢复这个上下文，将栈指针转移回用户栈，最后 mret 指令之后，就切换到了仙剑奇侠传的代码继续执行。</p>
<p>那么现在, 我就完成了 PA 的所有必做项目. (虽然选做还留了一堆坑)</p>
<p>整个 PA 全部做下来, 对于我这样的新手来说, 大概需要将近 300 个小时. 也陆陆续续做了快半年. 做这个 PA 不仅仅只是做了一个项目, 还顺带学习了一堆东西, 比如, vim, make, shell script, 以及这个笔记网站, 还有各种知识, 比如程序结构, 虚拟内存等等. 讲义里面老是强调状态机的事情, 做前面的内容还不以为意, 但是到了 PA4, 过程的复杂度就陡然上升了, 要模拟运行的过程把我的草稿纸都耗完了, 这才又回想起来.</p>
<p>非常感谢 PA, 那么 PA 就暂时告一段落了, 再见!</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-08-24</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-11-02</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/peter5723/peter5723.github.io" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>