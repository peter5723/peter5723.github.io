# 实际问题

我学习网络主要出于实用目的。这个笔记主要用于记录实际碰到的网络问题。

## 2025年9月16日

昨天实验室的电脑出现了网络问题。具体表现为连不上网，只有开启代理才能访问互联网。一开始以为是在关机时忘记关闭代理，导致代理程序异常退出，没有恢复代理设置。但是重启电脑后，重启代理程序再正常关闭仍然不能恢复。于是推测是代理程序可能改变了某种底层设置。然后再进行 ping 操作，发现不论 ping 什么网站，百度或必应，均连接超时，解析的 IP 地址均为 `172.32.255.254`。nslookup 则连接超时，也是只能返回前述的 IP 地址。于是推测是 DNS 服务出现了问题。DNS 服务器可能被窜改。想看哪一步被窜改，于是用 wireshark 抓包，查看是哪一步出了问题。然而令人惊奇的是抓取 WLAN 的包时，在打开百度的网址时，HTTP 协议和 TCP 协议均完成了应答，也就是说连接上了，但是网页却仍然不能显示，过滤 DNS 服务也可以找到百度的 IP 地址，说明 DNS 服务器也可以正常运转。然后，直接 ping 互联网上的 IP 地址，我 ping 了学校的 DNS 服务器，`10.10.0.21`，发现可以 ping 通。到这里我就推测是上层的某种设备改变了 DNS 服务的结果。我猜测是实验室的路由器，于是我拔掉了连接实验室局域网的网线。这样以后无线网就可以正常运作，访问互联网了。但是插上网线就又不行了。分析不出原因，走到隔壁实验室问同学是否有这种情况。一位学长告诉我说，最近实验室换了新的高速路由器，连不上网可能正是这个原因。路由中有一个 Metric 概念，中文称为跃点数。Metric 是用来衡量到达某个网络目的地路径成本的数值。一般来说，速度越快，Metric 值越小，那么这条路径就优先被选择。而实验室新买的路由器速度快，metric 很小，优先级很高容易被选择。这样就可以解释上面的问题。DNS 服务因为高速都走了有线网段，然而路由器不与互联网连接，所以只能返回错误的解析地址——但毕竟还是返回了。直接输入 IP 地址，可以 ping 通则是因为可能有流量走了无线网段以及 windows 网络的调度机制——无法连接就换路。拔掉网线可以正常访问互联网是因为流量可以走正常的无线网段。而开代理后可以正常工作则是流量直接从代理程序出来，IP 地址重新被外面的 DNS 服务器解析，就可以正常到达目的地。所以最后的解决方案很简单，手动降低 WLAN 的 Metric 值小于有线网段让流量优先走无线网即可。在管理者模式下 cmd 输入 `netsh interface ipv4 show interfaces`，`netsh interface ipv4 set interface "WLAN" metric=10` 即解决。

昨天校网出了问题，所以一度以为是校网导致的，最后发现并无关系，算是一个干扰项。