# xv6 源码阅读

## 1. 启动第一个进程

首先我们来看一下如何启动 xv6 以及开始第一个进程吧。（课程教材的 2.6 节）

机器启动后，xv6 从 `kernel/entry.S` 开始运行。启动时硬件分页机制未打开，物理地址等于虚拟地址。qemu 将 xv6 加载到地址 `0x80000000`,然后`_entry` 中设置栈， 栈的地址在 `start.c` 中确定，大小为 4096 乘以 CPU 个数，将 sp 的位置设置为栈顶（stack0+4096\*id）。设置好栈后，跳转到 `start()` 函数。


`start()` 函数的工作首先是在 machine 模式下进行一些必要的配置，然后切换到 supervisor 模式。这些配置包括，将 `main` 函数的地址写到 mepc 寄存器中，将 0 写入 satp 寄存器中使得在 supervisor 模式下，关闭页表地址的转换。然后打开时钟中断。执行完这些之后，使用 `mret` 进入 s 模式，并跳转到 `main()` 函数。

在 `main()` 函数中进行一系列必要的初始化后，调用 `user_init()`（在`proc.c`）来创建第一个进程（initcode.S）。这个进程执行 `exec` 系统调用，打开 `init` 程序，`init` 程序(init.c)打开shell，就这样完成了第一个进程，启动了系统。
